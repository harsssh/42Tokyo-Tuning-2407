# yaml-language-server: $schema=https://taskfile.dev/schema.json
# https://taskfile.dev
version: "3"

vars:
  CMD_INSTALL_DIR: /usr/local/bin

tasks:
  ####################
  #      Setup       #
  ####################
  all:
    desc: すべてのセットアップタスクを実行
    deps:
      - enable-autocompletion
      - gitconfig
      - install-rust
      # - taskfile-symlink
      # - task-alias
    cmds:
      - task: install-tools

  install-rust:
    desc: Rust をインストール
    cmds:
      - curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y -q
    status:
      - rustc --version

  install-tools:
    desc: ツールをインストール
    cmds:
      - sudo apt-get update -qq && sudo apt-get install -qq -y tree jq wget
      - task: install-bottom
      - task: install-bottom-config

  ####################
  #     Utility      #
  ####################

  ####################
  #     Internal     #
  ####################
  task-alias:
    internal: true
    cmds:
      - echo 'alias task="task -g"' >> ~/.bashrc
    status:
      - grep 'alias task="task -g"' ~/.bashrc

  enable-autocompletion:
    internal: true
    vars:
      COMPLETION_FILE_URL: https://raw.githubusercontent.com/go-task/task/main/completion/bash/task.bash
    cmds:
      - sudo wget -qO /etc/bash_completion.d/task.bash {{.COMPLETION_FILE_URL}}
      - sudo chmod +x /etc/bash_completion.d/task.bash
    status:
      - test -f /etc/bash_completion.d/task.bash

  taskfile-symlink:
    internal: true
    cmds:
      - ln -s {{.TASKFILE_DIR}}/Taskfile.yaml ~/Taskfile.yaml
    status:
      - test -L ~/Taskfile.yaml

  gitconfig:
    internal: true
    cmds:
      - git config --global user.name server
      - git config --global user.email server@example.com
      - git config --global core.editor vim
      - git config --global pull.rebase true
    status:
      - git config --global --get user.name
      - git config --global --get user.email
      - git config --global --get core.editor

  install-bottom:
    internal: true
    cmds:
      - cargo install -q --locked bottom
    status:
      - bottom --version

  install-bottom-config:
    internal: true
    cmds:
      - mkdir -p ~/.config/bottom
      - cp ./files/bottom.toml ~/.config/bottom/bottom.toml
    status:
      - diff ./files/bottom.toml ~/.config/bottom/bottom.toml &> /dev/null
